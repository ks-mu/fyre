<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Blog Post - Start Bootstrap Template</title>
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/recipe.css" rel="stylesheet">

    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script>
        function editRecipe() {
            var id = $("#id").html();
            var name = $("#name").html();
            var categories = $("#categories").html().split(",");
            var ingredients = $("#ingredients").html();
            var steps = $("#steps").html();
            var date = $("#date").html();
            $("#recipe-container").load("addRecipe.html");
            $(document).attr("title", "Editing of " + name);
            setTimeout(function (){
                $("#recipeName").val(name);
                $("#composition").val(ingredients);
                $("#cookingSteps").val(steps);
                setTimeout(function (){
                    $("#publicationDate").val(date);
                    $("#publicationDate").prop("disabled", true);
                }, 5);
                $("#img-form-group").remove();
                $("#select-form-group").remove();
                $("#submitRecipe").attr("onclick","submitChanges(" + id + ")");
            }, 100);
        }
        function submitChanges(id) {
            var check = true;
            $("#recipeForm input").each(function() {
                $(this).next("span").hide();
                if ($(this).val() == "") {
                    $(this).after("<span>This field is required</span>");
                    $(this).css("border-color","red");
                    check = false;
                } else {
                    $(this).css("border-color","");
                }
            });
            $("#recipeForm textarea").each(function() {
                $(this).next("span").hide();
                if ($(this).val() == "") {
                    $(this).after("<span>This field is required</span>");
                    $(this).css("border-color","red");
                    check = false;
                } else {
                    $(this).css("border-color","");
                }
            });
            $("#recipeForm select").each(function() {
                $(this).next("span").hide();
                if ($(this).val() == "") {
                    $(this).after("<span>This field is required</span>");
                    $(this).css("border-color","red");
                    check = false;
                } else {
                    $(this).css("border-color","");
                }
            });
            if (!check) {
                return;
            }
            var data = new FormData();
            data.append("recipeId", id);
            data.append("recipeName", $("#recipeName").val());
            data.append("cookingSteps", $("#cookingSteps").val());
            data.append("composition", $("#composition").val());
            $.ajax({
                url:"/update/recipe",
                type:"post",
                data,
                processData: false,
                contentType: false,
                complete: [
                    function (response) {
                        window.location.href = location.pathname.replace(window.location.href);
                    }
                ]
            });
        }
        function deleteRecipe() {
            var data = {
                recipeId: $("#id").html()
            };
            $.ajax({
                type: "post",
                url: "/delete/recipe",
                dataType: "json",
                data,
                contentType: "application/json; charset=utf-8",
                complete: [
                    function (response) {
                        window.location.href = location.pathname.replace(/(.*)\/[^/]*/, "$1/"+"mainPage.html");
                    }
                ]
            });
        }
        function approveRecipe() {
            var data = {
                recipeId: $("#id").html()
            };
            $.ajax({
                type: "post",
                url: "/recipeConfirmation",
                dataType: "json",
                data,
                contentType: "application/json; charset=utf-8",
                complete: [
                    function (response) {
                        var answer = $.parseJSON(response.responseText);
                        if (answer.obj == true) {
                            alert("Recipe approved");
                        } else {
                            alert("Something went wrong");
                        }
                    }
                ]
            });
        }
        $(function() {
            $("#load-recipes").hide();
            var data = {
                recipeId: window.localStorage.getItem("recipeId")
            };
            var user;
            $.ajax({
                url:"/session",
                type:"post",
                complete: [
                    function (response) {
                        user = $.parseJSON(response.responseText);
                    }
                ]
            });
            $.ajax({
                type: "post",
                url: "/recipe",
                dataType: "json",
                data,
                contentType: "application/json; charset=utf-8",
                complete: [
                    function (response) {
                        var answer = $.parseJSON(response.responseText);
                        console.log(response.responseText);
                        var urlString = window.location.href;
                        var url = new URL(urlString);
                        var isApprove = url.searchParams.get("isApprove");
                        if (typeof user.obj !== 'undefined') {
                            if (user.obj.login != answer.obj.creator && user.obj.role != "admin") {
                                $("#edit-recipe").remove();
                                $("#delete-recipe").remove();
                            }
                            if ((user.obj.role != "moderator" && user.obj.role != "admin") || isApprove == null) {
                                $("#approve-recipe").remove();
                            }
                        } else if (user.status == false) {
                            $("#recipe-btn .btn").remove();
                            $("#comment-form").remove();
                        }

                        $("meta[name='twitter:title']").attr("content", answer.obj.name);
                        $("meta[name='twitter:description']").attr("content", "Tasty meal");
                        //$("meta[name=' twitter:image']").attr("content", "/image?id=" + answer.obj.image);

                        $(document).attr("title", answer.obj.name);
                        $("#name").html(answer.obj.name);
                        $("#author").html(answer.obj.creator);
                        $("#date").html(answer.obj.publicationDate);
                        $("#categories").html(answer.obj.types.join(","));
                        $("#ingredients").html(answer.obj.composition.split("\n").join("<br>"));
                        $("#steps").html(answer.obj.cookingSteps.split("\n").join("<br>"));
                        $("#image").attr("src", "/image?id=" + answer.obj.image);
                        $("#id").html(answer.obj.id);
                        loadComments();
                    }
                ]
            });
        });
        function sendComment() {
            var data = {
                recipeId: $("#id").html(),
                commentText: $("#comment").val()
            }
            $.ajax({
                type: "post",
                url: "/add/comment",
                dataType: "json",
                data,
                contentType: "application/json; charset=utf-8",
                complete: [
                    function (response) {
                        var answer = $.parseJSON(response.responseText);
                        if (answer.obj != false) {
                            alert("Comment added");
                            loadComments();
                        }
                    }
                ]
            });
        }

        function loadComments() {
            var data = {
                recipeId: $("#id").html()
            }
            $.ajax({
                type: "post",
                url: "/select/comments",
                dataType: "json",
                data,
                contentType: "application/json; charset=utf-8",
                complete: [
                    function (response) {
                        var answer = $.parseJSON(response.responseText);
                        $("#comments").empty();
                        $.each(answer.obj, function(key, value) {
                            $("#comments").append("<div class='media mb-4'>"
                                + "<div class='media-body comment-text'>"
                                + "<h5 class='mt-0'>" + value.userLogin + "</h5>"
                                + value.commentText
                                + "</div></div><hr>");
                        });
                    }
                ]
            });
        }
    </script>
</head>

<body>
<!-- Page Content -->
<div class="container" id="recipe-container">
    <div class="row">
        <div class="col-lg-12 text-left">
            <!-- Title -->
            <h1 class="mt-4" id="name"></h1>
            <div hidden id="id"></div>
            <!-- Author -->
            <div class="lead" >Created by <a id="author"></a></div>
            <hr>
            <!-- Date/Time -->
            <div>Published on <a id="date"></a></div>
            <hr>
            <div>Categories: </div><a id="categories"></a>
            <hr>
            <!-- Preview Image -->
            <img class="img-fluid rounded" src="http://placehold.it/900x300" alt="" id="image">
            <hr>
            <!-- Post Content -->
            <div><h3>Ingredients:</h3></div>
            <div id="ingredients"></div>
            <div><h3>Cooking steps:</h3></div>
            <div id="steps"></div>
            <hr>
            <div id="recipe-btn">
                <button class="btn btn-primary" id="edit-recipe" onclick="editRecipe()">Edit recipe</button>
                <button class="btn btn-primary" id="delete-recipe" onclick="deleteRecipe()">Delete recipe</button>
                <button class="btn btn-primary" id="approve-recipe" onclick="approveRecipe()">Approve recipe</button>
            </div>
            <div id="comments-container">
                <div class="card my-4" id="comment-form">
                    <h5 class="card-header">Leave your comment:</h5>
                    <div class="card-body">
                        <div class="form-group">
                            <textarea class="form-control" rows="3" id="comment"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="sendComment()">Send</button>
                    </div>
                </div>

                <div class="card my-4">
                    <h5 class="card-header">Comments:</h5>
                    <div class="card-body">
                        <div id="comments">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
